{% extends "base.html" %}
{% load static %}

{% block title %}All Books | Second Hand Book{% endblock %}

{% block nav_heading %}
{% endblock %}

{% block body_class %}book-list-bg{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h1 class="h3 mb-1">Discover pre-loved books</h1>
      <p class="text-muted mb-0">Browse by title, author, or simply explore the covers.</p>
      {% if request.GET.q %}
      <p class="mt-2"><span class="badge text-bg-light">Results for “{{ request.GET.q }}”</span></p>
      {% endif %}
    </div>
  </div>
  <form class="mb-3" method="get">
    <div class="row g-2">
      <div class="col-md-3">
        <input type="text" class="form-control" name="q" placeholder="Search title, ISBN, description" value="{{ q }}">
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" name="author" placeholder="Author" value="{{ author }}">
      </div>
      <div class="col-md-3">
        <select class="form-select" name="genre">
          <option value="">All genres</option>
          {% for value,label in genre_choices %}
            <option value="{{ value }}" {% if value == genre %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="language">
          <option value="">All languages</option>
          {% for value,label in language_choices %}
            <option value="{{ value }}" {% if value == language %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <button class="btn btn-primary" type="submit">Filter</button>
      </div>
    </div>
  </form>

  <div id="book-grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-3 g-lg-4">
    {% include 'books/partials/_book_cards.html' %}
  </div>

  <div id="infinite-loader" class="text-center my-4" {% if not has_next %}style="display:none"{% endif %}>
    <div class="spinner-border text-secondary" role="status" aria-hidden="true"></div>
    <div class="mt-2 text-muted small">Loading more books…</div>
  </div>

  <div id="sentinel" class="py-1"></div>
</div>

<script>
(() => {
  const grid = document.getElementById('book-grid');
  const loader = document.getElementById('infinite-loader');
  const sentinel = document.getElementById('sentinel');

  let page = {{ page_obj.number|default:1 }};
  let hasNext = {{ has_next|yesno:'true,false' }};
  const q = new URLSearchParams(window.location.search).get('q') || '';
  let loading = false;

  function loadNext() {
    if (!hasNext || loading) return;
    loading = true;
    loader.style.display = '';

    const params = new URLSearchParams();
    params.set('page', String(page + 1));
    if (q) params.set('q', q);
    params.set('load', '1');

    fetch(`${window.location.pathname}?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(res => {
        if (!res.ok) throw new Error('Network response was not ok');
        return res.text();
      })
      .then(html => {
        if (!html.trim()) {
          hasNext = false;
          loader.style.display = 'none';
          return;
        }
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const nodes = temp.querySelectorAll('.col');
        nodes.forEach(n => grid.appendChild(n));
        page += 1;
        // We need to know if more pages exist; infer from length vs page size if needed
        hasNext = html.trim().length > 0; // server returns empty when no results
        if (!hasNext) loader.style.display = 'none';
      })
      .catch(() => { loader.style.display = 'none'; })
      .finally(() => { loading = false; });
  }

  const io = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) loadNext();
    });
  }, { rootMargin: '400px 0px' });

  if (hasNext) io.observe(sentinel);
})();
</script>
{% endblock %}
